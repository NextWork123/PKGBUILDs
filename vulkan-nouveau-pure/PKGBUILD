# Maintainer: Vasiliy Stelmachenok <ventureo@cachyos.org
## AUR maintainer:
# Maintainer: Echo J. <aidas957 at gmail dot com>
# shellcheck shell=bash disable=SC2034,SC2164

pkgname=vulkan-nouveau-pure
pkgdesc="Nouveau Vulkan (NVK) Mesa driver with some additions"
pkgver=25.2.2
pkgrel=1
arch=('x86_64')
depends=(
    'libdisplay-info'
    'libdrm'
    'libx11'
    'libxcb'
    'libxshmfence'
    'spirv-tools'
    'systemd-libs'
    'vulkan-icd-loader'
    'wayland'
    'zlib'
    'zstd'
)
makedepends=(
    'cbindgen'
    'clang'
    'elfutils'
    'git'
    'glslang'
    'libclc'
    'libunwind'
    'libxrandr'
    'llvm'
    'meson>=1.3.0rc2'
    'python-mako'
    'python-packaging'
    'python-yaml'
    'rust'
    'rust-bindgen'
    'spirv-llvm-translator'
    'systemd'
    'valgrind'
    'wayland-protocols'
    'xorgproto'
)
optdepends=(
    'vulkan-mesa-layers: Additional Vulkan layers'
    'linux-pure: Minimum required kernel for new uAPI support'
)
provides=('vulkan-driver')
conflicts=('vulkan-nouveau')
url="https://gitlab.freedesktop.org/mesa/mesa"
license=('MIT AND BSD-3-Clause AND SGI-B-2.0')
source=(
    "https://mesa.freedesktop.org/archive/mesa-$pkgver.tar.xz"
    36450.patch
)
sha512sums=(
    '69cd7ed33d0856e227a0219a9d09e5eb2fad28162276b5971bff4f7102cf58b0d914131ad6543562cba230ce6fb9b2076d3b156b1b8c375e74722a143aee5379'
    '3d46735b5c334151a5f740da752883508a4f1f5683fe82406ea94eb179dddeeaca49c5f0bafc8931dedb49d4896a2f74c6072128f14a90048ed229bfa1752f11'
)

prepare() {
    cd "mesa-$pkgver"

    # NVK Compression support on Turing+
    # Requires patched kernel
    # https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/36450
    patch -Np1 -i "${srcdir}/36450.patch"
}

build() {
    arch-meson "mesa-$pkgver" build \
        --reconfigure \
        --wrap-mode=nofallback \
        --force-fallback-for=paste,rustc-hash,syn \
        -D android-libbacktrace=disabled \
        -D b_ndebug=false \
        -D egl=disabled \
        -D expat=disabled \
        -D gallium-drivers= \
        -D gallium-extra-hud=false \
        -D gallium-mediafoundation=disabled \
        -D gallium-va=disabled \
        -D gallium-vdpau=disabled \
        -D gbm=disabled \
        -D gles1=disabled \
        -D gles2=disabled \
        -D glvnd=disabled \
        -D glx=disabled \
        -D libunwind=enabled \
        -D llvm=enabled \
        -D lmsensors=disabled \
        -D microsoft-clc=disabled \
        -D platforms=x11,wayland \
        -D valgrind=enabled \
        -D vulkan-drivers=nouveau \
        -D vulkan-layers= \
        -D xmlconfig=disabled

    meson compile -C build
}

package() {
    meson install -C build --destdir "${pkgdir}"
    install -Dm644 mesa-$pkgver/docs/license.rst -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
